const sugarDensity = 1.59;
const waterDensity = 1;
const alcoholDensity = 0.79;
export class Sugar {
    mass;
    name = 'Sugar';
    abv = 0;
    brix = 100;
    waterVolume = 0;
    waterMass = 0;
    alcoholVolume = 0;
    alcoholMass = 0;
    constructor(mass) {
        this.mass = mass;
    }
    clone() {
        return new Sugar(this.mass);
    }
    get sugarVolume() {
        return this.mass / sugarDensity;
    }
    get volume() {
        return this.sugarVolume;
    }
    get sugarMass() {
        return this.mass;
    }
}
export class Water {
    volume;
    abv = 0;
    brix = 0;
    sugarVolume = 0;
    sugarMass = 0;
    alcoholVolume = 0;
    alcoholMass = 0;
    constructor(volume) {
        this.volume = volume;
    }
    clone() {
        return new Water(this.volume);
    }
    get waterVolume() {
        return this.volume;
    }
    get waterMass() {
        return this.waterVolume * waterDensity;
    }
    get mass() {
        return this.waterMass;
    }
}
export class Ethanol {
    volume;
    abv = 100;
    brix = 0;
    sugarVolume = 0;
    sugarMass = 0;
    waterVolume = 0;
    waterMass = 0;
    constructor(volume) {
        this.volume = volume;
    }
    clone() {
        return new Ethanol(this.volume);
    }
    get alcoholVolume() {
        return this.volume;
    }
    get alcoholMass() {
        return this.alcoholVolume * alcoholDensity;
    }
    get mass() {
        return this.alcoholMass;
    }
}
export class Mixture {
    components;
    constructor(components) {
        this.components = components;
    }
    clone() {
        return new Mixture(Object.fromEntries(Object.entries(this.components).map(([key, component]) => [
            key,
            component.clone(),
        ])));
    }
    get abv() {
        return 100 * this.alcoholVolume / this.volume;
    }
    get brix() {
        return 100 * this.sugarMass / this.mass;
    }
    get volume() {
        return this.sumComponents('volume');
    }
    get waterVolume() {
        return this.sumComponents('waterVolume');
    }
    get waterMass() {
        return this.sumComponents('waterMass');
    }
    get alcoholVolume() {
        return this.sumComponents('alcoholVolume');
    }
    get alcoholMass() {
        return this.sumComponents('alcoholMass');
    }
    get sugarVolume() {
        return this.sumComponents('sugarVolume');
    }
    get sugarMass() {
        return this.sumComponents('sugarMass');
    }
    get mass() {
        return this.sumComponents('mass');
    }
    sumComponents(key) {
        return Object.values(this.components).reduce((sum, component) => sum + component[key], 0);
    }
    analyze(precision = 0) {
        return {
            volume: round(this.volume, precision),
            mass: round(this.mass, precision),
            abv: round(this.abv, precision),
            brix: round(this.brix, precision),
        };
    }
}
function round(value, precision) {
    const factor = 10 ** precision;
    return Math.round(value * factor) / factor;
}
export class Syrup extends Mixture {
    _volume;
    _brix;
    constructor(brix, volume) {
        super({
            water: new Water(0),
            sugar: new Sugar(0),
        });
        this._volume = volume;
        this._brix = brix;
        this.updateComponents();
    }
    clone() {
        return new Syrup(this._volume, this._brix);
    }
    updateComponents() {
        this.components.water = new Water(this._volume * (1 - this._brix / 100));
        this.components.sugar = new Sugar(this._volume * (this._brix / 100));
    }
    get volume() {
        return super.volume;
    }
    set volume(volume) {
        this._volume = volume;
        this.updateComponents();
    }
}
export class Spirit extends Mixture {
    _volume;
    _abv;
    constructor(volume, abv) {
        super({
            water: new Water(0),
            ethanol: new Ethanol(0),
        });
        this._volume = volume;
        this._abv = abv;
        this.updateComponents();
    }
    clone() {
        return new Spirit(this._volume, this._abv);
    }
    updateComponents() {
        this.components.water = new Water(this._volume * (1 - this._abv / 100));
        this.components.ethanol = new Ethanol(this._volume * (this._abv / 100));
    }
    get volume() {
        return super.volume;
    }
    set volume(volume) {
        this._volume = volume;
        this.updateComponents();
    }
}
export function solve(sourceSpirit, targetAbv, targetBrix, sourceSweetenerBrix = 100) {
    if (targetAbv > sourceSpirit.abv) {
        throw new Error(`Target ABV (${targetAbv}) must be less than source ABV (${sourceSpirit.abv})`);
    }
    const volumeAtTargetAbv = sourceSpirit.alcoholVolume / (targetAbv / 100);
    const mixture = new Mixture({
        ethanol: sourceSpirit.components.ethanol.clone(),
        water: new Water(volumeAtTargetAbv * (1 - targetBrix / 100)),
        sugar: new Sugar(volumeAtTargetAbv * (targetBrix / 100)),
    });
    const components = mixture.components;
    let error = 1;
    let iterations = 1000;
    while (error > 0.01 && --iterations > 0) {
        const dError_dAbv = (targetAbv - mixture.abv) / 100;
        const dError_dBrix = (targetBrix - mixture.brix) / 100;
        const { volume, mass } = mixture;
        // is abv is below target, we need less water
        components.water.volume -= volume * dError_dAbv;
        // if brix is below target, we need more sugar
        components.sugar.mass *= 1 + dError_dBrix;
        // if brix is below target, we need less water
        components.water.volume -= mass * dError_dBrix;
        // Ensure component volumes and mass stay within the valid range
        components.ethanol.volume = Math.min(sourceSpirit.alcoholVolume, Math.max(0, components.ethanol.volume));
        components.water.volume = Math.max(0, components.water.volume);
        components.sugar.mass = Math.max(0, components.sugar.mass);
        error = Math.sqrt((mixture.abv - targetAbv) ** 2 + (mixture.brix - targetBrix) ** 2);
    }
    // now convert the volume of ethanol to an equivalent volume of spirit
    const targetSpirit = new Spirit(Math.round(mixture.alcoholVolume / (sourceSpirit.abv / 100)), sourceSpirit.abv);
    const targetSyrup = new Syrup(sourceSweetenerBrix, Math.round(100 * mixture.sugarMass / sourceSweetenerBrix));
    const targetWater = new Water(Math.round(mixture.waterVolume - targetSyrup.waterVolume - targetSpirit.waterVolume));
    const output = new Mixture({
        spirit: targetSpirit,
        syrup: targetSyrup,
        water: targetWater,
    });
    return {
        mixture: output,
        error,
        iterations: 1000 - iterations,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29sdXRpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic29sdXRpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUM7QUFDMUIsTUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQztBQUU1QixNQUFNLE9BQU8sS0FBSztJQVNHO0lBUlYsSUFBSSxHQUFHLE9BQU8sQ0FBQztJQUNmLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFDUixJQUFJLEdBQUcsR0FBRyxDQUFDO0lBQ1gsV0FBVyxHQUFHLENBQUMsQ0FBQztJQUNoQixTQUFTLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsYUFBYSxHQUFHLENBQUMsQ0FBQztJQUNsQixXQUFXLEdBQUcsQ0FBQyxDQUFDO0lBRXpCLFlBQW1CLElBQVk7UUFBWixTQUFJLEdBQUosSUFBSSxDQUFRO0lBQUcsQ0FBQztJQUNuQyxLQUFLO1FBQ0gsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUNELElBQUksV0FBVztRQUNiLE9BQU8sSUFBSSxDQUFDLElBQUksR0FBRyxZQUFZLENBQUM7SUFDbEMsQ0FBQztJQUNELElBQUksTUFBTTtRQUNSLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDO0lBQ0QsSUFBSSxTQUFTO1FBQ1gsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7Q0FDRjtBQUVELE1BQU0sT0FBTyxLQUFLO0lBUUc7SUFQVixHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQ1IsSUFBSSxHQUFHLENBQUMsQ0FBQztJQUNULFdBQVcsR0FBRyxDQUFDLENBQUM7SUFDaEIsU0FBUyxHQUFHLENBQUMsQ0FBQztJQUNkLGFBQWEsR0FBRyxDQUFDLENBQUM7SUFDbEIsV0FBVyxHQUFHLENBQUMsQ0FBQztJQUV6QixZQUFtQixNQUFjO1FB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SUFBSSxHQUFHLFVBQVU7S0FDOUIsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbnRlcmZhY2UgQ29tcG9uZW50RGF0YSB7XG4gIGFidjogbnVtYmVyO1xuICBicml4OiBudW1iZXI7XG4gIHZvbHVtZTogbnVtYmVyO1xuICBtYXNzOiBudW1iZXI7XG4gIHN1Z2FyVm9sdW1lOiBudW1iZXI7XG4gIHdhdGVyVm9sdW1lOiBudW1iZXI7XG4gIGFsY29ob2xWb2x1bWU6IG51bWJlcjtcbiAgc3VnYXJNYXNzOiBudW1iZXI7XG4gIHdhdGVyTWFzczogbnVtYmVyO1xuICBhbGNvaG9sTWFzczogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgQ29tcG9uZW50IGV4dGVuZHMgQ29tcG9uZW50RGF0YSB7XG4gIGNsb25lKCk6IENvbXBvbmVudDtcbn1cblxuY29uc3Qgc3VnYXJEZW5zaXR5ID0gMS41OTtcbmNvbnN0IHdhdGVyRGVuc2l0eSA9IDE7XG5jb25zdCBhbGNvaG9sRGVuc2l0eSA9IDAuNzk7XG5cbmV4cG9ydCBjbGFzcyBTdWdhciBpbXBsZW1lbnRzIENvbXBvbmVudCB7XG4gIHJlYWRvbmx5IG5hbWUgPSAnU3VnYXInO1xuICByZWFkb25seSBhYnYgPSAwO1xuICByZWFkb25seSBicml4ID0gMTAwO1xuICByZWFkb25seSB3YXRlclZvbHVtZSA9IDA7XG4gIHJlYWRvbmx5IHdhdGVyTWFzcyA9IDA7XG4gIHJlYWRvbmx5IGFsY29ob2xWb2x1bWUgPSAwO1xuICByZWFkb25seSBhbGNvaG9sTWFzcyA9IDA7XG5cbiAgY29uc3RydWN0b3IocHVibGljIG1hc3M6IG51bWJlcikge31cbiAgY2xvbmUoKSB7XG4gICAgcmV0dXJuIG5ldyBTdWdhcih0aGlzLm1hc3MpO1xuICB9XG4gIGdldCBzdWdhclZvbHVtZSgpIHtcbiAgICByZXR1cm4gdGhpcy5tYXNzIC8gc3VnYXJEZW5zaXR5O1xuICB9XG4gIGdldCB2b2x1bWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3VnYXJWb2x1bWU7XG4gIH1cbiAgZ2V0IHN1Z2FyTWFzcygpIHtcbiAgICByZXR1cm4gdGhpcy5tYXNzO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBXYXRlciBpbXBsZW1lbnRzIENvbXBvbmVudCB7XG4gIHJlYWRvbmx5IGFidiA9IDA7XG4gIHJlYWRvbmx5IGJyaXggPSAwO1xuICByZWFkb25seSBzdWdhclZvbHVtZSA9IDA7XG4gIHJlYWRvbmx5IHN1Z2FyTWFzcyA9IDA7XG4gIHJlYWRvbmx5IGFsY29ob2xWb2x1bWUgPSAwO1xuICByZWFkb25seSBhbGNvaG9sTWFzcyA9IDA7XG5cbiAgY29uc3RydWN0b3IocHVibGljIHZvbHVtZTogbnVtYmVyKSB7fVxuICBjbG9uZSgpIHtcbiAgICByZXR1cm4gbmV3IFdhdGVyKHRoaXMudm9sdW1lKTtcbiAgfVxuICBnZXQgd2F0ZXJWb2x1bWUoKSB7XG4gICAgcmV0dXJuIHRoaXMudm9sdW1lO1xuICB9XG4gIGdldCB3YXRlck1hc3MoKSB7XG4gICAgcmV0dXJuIHRoaXMud2F0ZXJWb2x1bWUgKiB3YXRlckRlbnNpdHk7XG4gIH1cbiAgZ2V0IG1hc3MoKSB7XG4gICAgcmV0dXJuIHRoaXMud2F0ZXJNYXNzO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBFdGhhbm9sIGltcGxlbWVudHMgQ29tcG9uZW50IHtcbiAgcmVhZG9ubHkgYWJ2ID0gMTAwO1xuICByZWFkb25seSBicml4ID0gMDtcbiAgcmVhZG9ubHkgc3VnYXJWb2x1bWUgPSAwO1xuICByZWFkb25seSBzdWdhck1hc3MgPSAwO1xuICByZWFkb25seSB3YXRlclZvbHVtZSA9IDA7XG4gIHJlYWRvbmx5IHdhdGVyTWFzcyA9IDA7XG5cbiAgY29uc3RydWN0b3IocHVibGljIHZvbHVtZTogbnVtYmVyKSB7fVxuICBjbG9uZSgpIHtcbiAgICByZXR1cm4gbmV3IEV0aGFub2wodGhpcy52b2x1bWUpO1xuICB9XG4gIGdldCBhbGNvaG9sVm9sdW1lKCkge1xuICAgIHJldHVybiB0aGlzLnZvbHVtZTtcbiAgfVxuICBnZXQgYWxjb2hvbE1hc3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuYWxjb2hvbFZvbHVtZSAqIGFsY29ob2xEZW5zaXR5O1xuICB9XG4gIGdldCBtYXNzKCkge1xuICAgIHJldHVybiB0aGlzLmFsY29ob2xNYXNzO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBNaXh0dXJlPFQgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBDb21wb25lbnQ+PiBpbXBsZW1lbnRzIENvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHJlYWRvbmx5IGNvbXBvbmVudHM6IFQsXG4gICkge1xuICB9XG5cbiAgY2xvbmUoKSB7XG4gICAgcmV0dXJuIG5ldyBNaXh0dXJlPFQ+KFxuICAgICAgT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgICAgICBPYmplY3QuZW50cmllcyh0aGlzLmNvbXBvbmVudHMpLm1hcCgoW2tleSwgY29tcG9uZW50XSkgPT4gW1xuICAgICAgICAgIGtleSxcbiAgICAgICAgICBjb21wb25lbnQuY2xvbmUoKSxcbiAgICAgICAgXSksXG4gICAgICApIGFzIFQsXG4gICAgKTtcbiAgfVxuICBnZXQgYWJ2KCkge1xuICAgIHJldHVybiAxMDAgKiB0aGlzLmFsY29ob2xWb2x1bWUgLyB0aGlzLnZvbHVtZTtcbiAgfVxuICBnZXQgYnJpeCgpIHtcbiAgICByZXR1cm4gMTAwICogdGhpcy5zdWdhck1hc3MgLyB0aGlzLm1hc3M7XG4gIH1cbiAgZ2V0IHZvbHVtZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zdW1Db21wb25lbnRzKCd2b2x1bWUnKTtcbiAgfVxuICBnZXQgd2F0ZXJWb2x1bWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3VtQ29tcG9uZW50cygnd2F0ZXJWb2x1bWUnKTtcbiAgfVxuICBnZXQgd2F0ZXJNYXNzKCkge1xuICAgIHJldHVybiB0aGlzLnN1bUNvbXBvbmVudHMoJ3dhdGVyTWFzcycpO1xuICB9XG4gIGdldCBhbGNvaG9sVm9sdW1lKCkge1xuICAgIHJldHVybiB0aGlzLnN1bUNvbXBvbmVudHMoJ2FsY29ob2xWb2x1bWUnKTtcbiAgfVxuICBnZXQgYWxjb2hvbE1hc3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3VtQ29tcG9uZW50cygnYWxjb2hvbE1hc3MnKTtcbiAgfVxuICBnZXQgc3VnYXJWb2x1bWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3VtQ29tcG9uZW50cygnc3VnYXJWb2x1bWUnKTtcbiAgfVxuICBnZXQgc3VnYXJNYXNzKCkge1xuICAgIHJldHVybiB0aGlzLnN1bUNvbXBvbmVudHMoJ3N1Z2FyTWFzcycpO1xuICB9XG4gIGdldCBtYXNzKCkge1xuICAgIHJldHVybiB0aGlzLnN1bUNvbXBvbmVudHMoJ21hc3MnKTtcbiAgfVxuXG4gIHByaXZhdGUgc3VtQ29tcG9uZW50cyhrZXk6IGtleW9mIENvbXBvbmVudERhdGEpOiBudW1iZXIge1xuICAgIHJldHVybiBPYmplY3QudmFsdWVzKHRoaXMuY29tcG9uZW50cykucmVkdWNlKFxuICAgICAgKHN1bSwgY29tcG9uZW50KSA9PiBzdW0gKyBjb21wb25lbnRba2V5XSxcbiAgICAgIDAsXG4gICAgKTtcbiAgfVxuXG4gIGFuYWx5emUocHJlY2lzaW9uID0gMCk6IFRhcmdldCAmIHtcbiAgICBtYXNzOiBudW1iZXI7XG4gIH0ge1xuICAgIHJldHVybiB7XG4gICAgICB2b2x1bWU6IHJvdW5kKHRoaXMudm9sdW1lLCBwcmVjaXNpb24pLFxuICAgICAgbWFzczogcm91bmQodGhpcy5tYXNzLCBwcmVjaXNpb24pLFxuICAgICAgYWJ2OiByb3VuZCh0aGlzLmFidiwgcHJlY2lzaW9uKSxcbiAgICAgIGJyaXg6IHJvdW5kKHRoaXMuYnJpeCwgcHJlY2lzaW9uKSxcbiAgICB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIHJvdW5kKHZhbHVlOiBudW1iZXIsIHByZWNpc2lvbjogbnVtYmVyKSB7XG4gIGNvbnN0IGZhY3RvciA9IDEwICoqIHByZWNpc2lvbjtcbiAgcmV0dXJuIE1hdGgucm91bmQodmFsdWUgKiBmYWN0b3IpIC8gZmFjdG9yO1xufVxuXG5leHBvcnQgY2xhc3MgU3lydXAgZXh0ZW5kcyBNaXh0dXJlPHsgd2F0ZXI6IFdhdGVyOyBzdWdhcjogU3VnYXIgfT4ge1xuICBwcml2YXRlIF92b2x1bWU6IG51bWJlcjtcbiAgcHJpdmF0ZSBfYnJpeDogbnVtYmVyO1xuICBjb25zdHJ1Y3RvcihcbiAgICBicml4OiBudW1iZXIsXG4gICAgdm9sdW1lOiBudW1iZXIsXG4gICkge1xuICAgIHN1cGVyKHtcbiAgICAgIHdhdGVyOiBuZXcgV2F0ZXIoMCksXG4gICAgICBzdWdhcjogbmV3IFN1Z2FyKDApLFxuICAgIH0pO1xuICAgIHRoaXMuX3ZvbHVtZSA9IHZvbHVtZTtcbiAgICB0aGlzLl9icml4ID0gYnJpeDtcbiAgICB0aGlzLnVwZGF0ZUNvbXBvbmVudHMoKTtcbiAgfVxuXG4gIGNsb25lKCkge1xuICAgIHJldHVybiBuZXcgU3lydXAodGhpcy5fdm9sdW1lLCB0aGlzLl9icml4KTtcbiAgfVxuXG4gIHVwZGF0ZUNvbXBvbmVudHMoKSB7XG4gICAgdGhpcy5jb21wb25lbnRzLndhdGVyID0gbmV3IFdhdGVyKHRoaXMuX3ZvbHVtZSAqICgxIC0gdGhpcy5fYnJpeCAvIDEwMCkpO1xuICAgIHRoaXMuY29tcG9uZW50cy5zdWdhciA9IG5ldyBTdWdhcih0aGlzLl92b2x1bWUgKiAodGhpcy5fYnJpeCAvIDEwMCkpO1xuICB9XG5cbiAgZ2V0IHZvbHVtZSgpIHtcbiAgICByZXR1cm4gc3VwZXIudm9sdW1lO1xuICB9XG5cbiAgc2V0IHZvbHVtZSh2b2x1bWU6IG51bWJlcikge1xuICAgIHRoaXMuX3ZvbHVtZSA9IHZvbHVtZTtcbiAgICB0aGlzLnVwZGF0ZUNvbXBvbmVudHMoKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgU3Bpcml0IGV4dGVuZHMgTWl4dHVyZTx7IHdhdGVyOiBXYXRlcjsgZXRoYW5vbDogRXRoYW5vbCB9PiB7XG4gIHByaXZhdGUgX3ZvbHVtZTogbnVtYmVyO1xuICBwcml2YXRlIF9hYnY6IG51bWJlcjtcbiAgY29uc3RydWN0b3IoXG4gICAgdm9sdW1lOiBudW1iZXIsXG4gICAgYWJ2OiBudW1iZXIsXG4gICkge1xuICAgIHN1cGVyKHtcbiAgICAgIHdhdGVyOiBuZXcgV2F0ZXIoMCksXG4gICAgICBldGhhbm9sOiBuZXcgRXRoYW5vbCgwKSxcbiAgICB9KTtcbiAgICB0aGlzLl92b2x1bWUgPSB2b2x1bWU7XG4gICAgdGhpcy5fYWJ2ID0gYWJ2O1xuICAgIHRoaXMudXBkYXRlQ29tcG9uZW50cygpO1xuICB9XG5cbiAgY2xvbmUoKSB7XG4gICAgcmV0dXJuIG5ldyBTcGlyaXQodGhpcy5fdm9sdW1lLCB0aGlzLl9hYnYpO1xuICB9XG5cbiAgdXBkYXRlQ29tcG9uZW50cygpIHtcbiAgICB0aGlzLmNvbXBvbmVudHMud2F0ZXIgPSBuZXcgV2F0ZXIodGhpcy5fdm9sdW1lICogKDEgLSB0aGlzLl9hYnYgLyAxMDApKTtcbiAgICB0aGlzLmNvbXBvbmVudHMuZXRoYW5vbCA9IG5ldyBFdGhhbm9sKHRoaXMuX3ZvbHVtZSAqICh0aGlzLl9hYnYgLyAxMDApKTtcbiAgfVxuXG4gIGdldCB2b2x1bWUoKSB7XG4gICAgcmV0dXJuIHN1cGVyLnZvbHVtZTtcbiAgfVxuXG4gIHNldCB2b2x1bWUodm9sdW1lOiBudW1iZXIpIHtcbiAgICB0aGlzLl92b2x1bWUgPSB2b2x1bWU7XG4gICAgdGhpcy51cGRhdGVDb21wb25lbnRzKCk7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBUYXJnZXQge1xuICBhYnY6IG51bWJlcjtcbiAgYnJpeDogbnVtYmVyO1xuICB2b2x1bWU6IG51bWJlcjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNvbHZlKFxuICBzb3VyY2VTcGlyaXQ6IFNwaXJpdCxcbiAgdGFyZ2V0QWJ2OiBudW1iZXIsXG4gIHRhcmdldEJyaXg6IG51bWJlcixcbiAgc291cmNlU3dlZXRlbmVyQnJpeCA9IDEwMCwgLy8gcHVyZSBzdWdhclxuKSB7XG4gIGlmICh0YXJnZXRBYnYgPiBzb3VyY2VTcGlyaXQuYWJ2KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYFRhcmdldCBBQlYgKCR7dGFyZ2V0QWJ2fSkgbXVzdCBiZSBsZXNzIHRoYW4gc291cmNlIEFCViAoJHtzb3VyY2VTcGlyaXQuYWJ2fSlgLFxuICAgICk7XG4gIH1cblxuICBjb25zdCB2b2x1bWVBdFRhcmdldEFidiA9IHNvdXJjZVNwaXJpdC5hbGNvaG9sVm9sdW1lIC8gKHRhcmdldEFidiAvIDEwMCk7XG5cbiAgY29uc3QgbWl4dHVyZSA9IG5ldyBNaXh0dXJlKHtcbiAgICBldGhhbm9sOiBzb3VyY2VTcGlyaXQuY29tcG9uZW50cy5ldGhhbm9sLmNsb25lKCksXG4gICAgd2F0ZXI6IG5ldyBXYXRlcih2b2x1bWVBdFRhcmdldEFidiAqICgxIC0gdGFyZ2V0QnJpeCAvIDEwMCkpLFxuICAgIHN1Z2FyOiBuZXcgU3VnYXIodm9sdW1lQXRUYXJnZXRBYnYgKiAodGFyZ2V0QnJpeCAvIDEwMCkpLFxuICB9KTtcblxuICBjb25zdCBjb21wb25lbnRzID0gbWl4dHVyZS5jb21wb25lbnRzO1xuXG4gIGxldCBlcnJvciA9IDE7XG4gIGxldCBpdGVyYXRpb25zID0gMTAwMDtcbiAgd2hpbGUgKGVycm9yID4gMC4wMSAmJiAtLWl0ZXJhdGlvbnMgPiAwKSB7XG4gICAgY29uc3QgZEVycm9yX2RBYnYgPSAodGFyZ2V0QWJ2IC0gbWl4dHVyZS5hYnYpIC8gMTAwO1xuICAgIGNvbnN0IGRFcnJvcl9kQnJpeCA9ICh0YXJnZXRCcml4IC0gbWl4dHVyZS5icml4KSAvIDEwMDtcbiAgICBjb25zdCB7IHZvbHVtZSwgbWFzcyB9ID0gbWl4dHVyZTtcblxuICAgIC8vIGlzIGFidiBpcyBiZWxvdyB0YXJnZXQsIHdlIG5lZWQgbGVzcyB3YXRlclxuICAgIGNvbXBvbmVudHMud2F0ZXIudm9sdW1lIC09IHZvbHVtZSAqIGRFcnJvcl9kQWJ2O1xuICAgIC8vIGlmIGJyaXggaXMgYmVsb3cgdGFyZ2V0LCB3ZSBuZWVkIG1vcmUgc3VnYXJcbiAgICBjb21wb25lbnRzLnN1Z2FyLm1hc3MgKj0gMSArIGRFcnJvcl9kQnJpeDtcbiAgICAvLyBpZiBicml4IGlzIGJlbG93IHRhcmdldCwgd2UgbmVlZCBsZXNzIHdhdGVyXG4gICAgY29tcG9uZW50cy53YXRlci52b2x1bWUgLT0gbWFzcyAqIGRFcnJvcl9kQnJpeDtcblxuICAgIC8vIEVuc3VyZSBjb21wb25lbnQgdm9sdW1lcyBhbmQgbWFzcyBzdGF5IHdpdGhpbiB0aGUgdmFsaWQgcmFuZ2VcbiAgICBjb21wb25lbnRzLmV0aGFub2wudm9sdW1lID0gTWF0aC5taW4oXG4gICAgICBzb3VyY2VTcGlyaXQuYWxjb2hvbFZvbHVtZSxcbiAgICAgIE1hdGgubWF4KDAsIGNvbXBvbmVudHMuZXRoYW5vbC52b2x1bWUpLFxuICAgICk7XG4gICAgY29tcG9uZW50cy53YXRlci52b2x1bWUgPSBNYXRoLm1heCgwLCBjb21wb25lbnRzLndhdGVyLnZvbHVtZSk7XG4gICAgY29tcG9uZW50cy5zdWdhci5tYXNzID0gTWF0aC5tYXgoMCwgY29tcG9uZW50cy5zdWdhci5tYXNzKTtcblxuICAgIGVycm9yID0gTWF0aC5zcXJ0KFxuICAgICAgKG1peHR1cmUuYWJ2IC0gdGFyZ2V0QWJ2KSAqKiAyICsgKG1peHR1cmUuYnJpeCAtIHRhcmdldEJyaXgpICoqIDIsXG4gICAgKTtcbiAgfVxuXG4gIC8vIG5vdyBjb252ZXJ0IHRoZSB2b2x1bWUgb2YgZXRoYW5vbCB0byBhbiBlcXVpdmFsZW50IHZvbHVtZSBvZiBzcGlyaXRcbiAgY29uc3QgdGFyZ2V0U3Bpcml0ID0gbmV3IFNwaXJpdChcbiAgICBNYXRoLnJvdW5kKG1peHR1cmUuYWxjb2hvbFZvbHVtZSAvIChzb3VyY2VTcGlyaXQuYWJ2IC8gMTAwKSksXG4gICAgc291cmNlU3Bpcml0LmFidixcbiAgKTtcbiAgY29uc3QgdGFyZ2V0U3lydXAgPSBuZXcgU3lydXAoXG4gICAgc291cmNlU3dlZXRlbmVyQnJpeCxcbiAgICBNYXRoLnJvdW5kKDEwMCAqIG1peHR1cmUuc3VnYXJNYXNzIC8gc291cmNlU3dlZXRlbmVyQnJpeCksXG4gICk7XG4gIGNvbnN0IHRhcmdldFdhdGVyID0gbmV3IFdhdGVyKFxuICAgIE1hdGgucm91bmQoXG4gICAgICBtaXh0dXJlLndhdGVyVm9sdW1lIC0gdGFyZ2V0U3lydXAud2F0ZXJWb2x1bWUgLSB0YXJnZXRTcGlyaXQud2F0ZXJWb2x1bWUsXG4gICAgKSxcbiAgKTtcblxuICBjb25zdCBvdXRwdXQgPSBuZXcgTWl4dHVyZSh7XG4gICAgc3Bpcml0OiB0YXJnZXRTcGlyaXQsXG4gICAgc3lydXA6IHRhcmdldFN5cnVwLFxuICAgIHdhdGVyOiB0YXJnZXRXYXRlcixcbiAgfSk7XG5cbiAgcmV0dXJuIHtcbiAgICBtaXh0dXJlOiBvdXRwdXQsXG4gICAgZXJyb3IsXG4gICAgaXRlcmF0aW9uczogMTAwMCAtIGl0ZXJhdGlvbnMsXG4gIH07XG59XG4iXX0=